apiVersion: v1
kind: ConfigMap
metadata:
  name: mongo-init-script
  namespace: diaspomoney
data:
  mongo-init.js: |
    // Script d'initialisation MongoDB pour DiaspoMoney
    // Ce script s'ex√©cute automatiquement au premier d√©marrage du conteneur MongoDB

    // Se connecter √† la base de donn√©es diaspomoney
    db = db.getSiblingDB('diaspomoney');

    // V√©rifier si la base de donn√©es existe d√©j√† (pour √©viter d'√©craser les donn√©es)
    const existingCollections = db.getCollectionNames();
    if (existingCollections.length > 0) {
      print('‚ö†Ô∏è  Base de donn√©es existante d√©tect√©e. Le script d\'initialisation sera ignor√© pour pr√©server les donn√©es.');
      print('üìä Collections existantes: ' + existingCollections.join(', '));
      quit(0);
    }

    print('üÜï Initialisation d\'une nouvelle base de donn√©es...');

    // Cr√©er un utilisateur pour l'application (seulement si n'existe pas)
    try {
      db.createUser({
        user: 'diaspomoney',
        pwd: 'password123',
        roles: [
          {
            role: 'readWrite',
            db: 'diaspomoney',
          },
        ],
      });
      print('‚úÖ Utilisateur diaspomoney cr√©√©');
    } catch (e) {
      if (e.code === 51003) {
        print('‚ÑπÔ∏è  Utilisateur diaspomoney existe d√©j√†');
      } else {
        throw e;
      }
    }

    // Cr√©er les collections de base avec des index
    print('Cr√©ation des collections de base...');

    // Collection des utilisateurs (mod√®le mis √† jour)
    if (!db.getCollectionNames().includes('users')) {
      db.createCollection('users');
      db.users.createIndex({ email: 1 }, { unique: true });
      db.users.createIndex({ phone: 1 });
      db.users.createIndex({ roles: 1 }); // Chang√© de 'role' √† 'roles' (array)
      db.users.createIndex({ status: 1 });
      db.users.createIndex({ createdAt: 1 });
      db.users.createIndex({ emailVerified: 1 });
      db.users.createIndex({ isEmailVerified: 1 });
    }

    // Collection des services
    if (!db.getCollectionNames().includes('services')) {
      db.createCollection('services');
      db.services.createIndex({ name: 1 });
      db.services.createIndex({ category: 1 });
      db.services.createIndex({ providerId: 1 });
      db.services.createIndex({ isActive: 1 });
    }

    // Collection des rendez-vous
    if (!db.getCollectionNames().includes('bookings')) {
      db.createCollection('bookings');
      db.bookings.createIndex({ providerId: 1 });
      db.bookings.createIndex({ requesterId: 1 });
      db.bookings.createIndex({ date: 1 });
      db.bookings.createIndex({ status: 1 });
      db.bookings.createIndex({ createdAt: 1 });
    }

    // Collection des factures
    if (!db.getCollectionNames().includes('invoices')) {
      db.createCollection('invoices');
      db.invoices.createIndex({ userId: 1 });
      db.invoices.createIndex({ bookingId: 1 });
      db.invoices.createIndex({ status: 1 });
      db.invoices.createIndex({ createdAt: 1 });
    }

    // Collection des transactions
    if (!db.getCollectionNames().includes('transactions')) {
      db.createCollection('transactions');
      db.transactions.createIndex({ userId: 1 });
      db.transactions.createIndex({ type: 1 });
      db.transactions.createIndex({ status: 1 });
      db.transactions.createIndex({ createdAt: 1 });
    }

    // Collection des partenaires
    if (!db.getCollectionNames().includes('partners')) {
      db.createCollection('partners');
      db.partners.createIndex({ name: 1 });
      db.partners.createIndex({ category: 1 });
      db.partners.createIndex({ isActive: 1 });
    }

    // Collection des sp√©cialit√©s
    if (!db.getCollectionNames().includes('specialities')) {
      db.createCollection('specialities');
      db.specialities.createIndex({ name: 1 });
      db.specialities.createIndex({ category: 1 });
    }

    // Collection des tokens de v√©rification email
    if (!db.getCollectionNames().includes('emailverificationtokens')) {
      db.createCollection('emailverificationtokens');
      db.emailverificationtokens.createIndex({ token: 1 }, { unique: true });
      db.emailverificationtokens.createIndex({ userId: 1 });
      db.emailverificationtokens.createIndex(
        { expiresAt: 1 },
        { expireAfterSeconds: 0 }
      );
    }

    // Collection des tokens de r√©initialisation de mot de passe
    if (!db.getCollectionNames().includes('passwordresettokens')) {
      db.createCollection('passwordresettokens');
      db.passwordresettokens.createIndex({ token: 1 }, { unique: true });
      db.passwordresettokens.createIndex({ userId: 1 });
      db.passwordresettokens.createIndex({ expiresAt: 1 }, { expireAfterSeconds: 0 });
    }

    // Collection des tokens de retry
    if (!db.getCollectionNames().includes('retrytokens')) {
      db.createCollection('retrytokens');
      db.retrytokens.createIndex({ token: 1 }, { unique: true });
      db.retrytokens.createIndex({ userId: 1 });
      db.retrytokens.createIndex({ expiresAt: 1 }, { expireAfterSeconds: 0 });
    }

    // Ins√©rer des donn√©es de test (seulement si elles n'existent pas)
    print('Insertion des donn√©es de test...');

    // Utilisateur admin par d√©faut (mod√®le mis √† jour) - seulement si n'existe pas
    const existingAdmin = db.users.findOne({ email: 'admin@diaspomoney.fr' });
    if (!existingAdmin) {
      db.users.insertOne({
      _id: ObjectId(),
      name: 'Admin DiaspoMoney',
      firstName: 'Admin',
      lastName: 'DiaspoMoney',
      email: 'admin@diaspomoney.fr',
      phone: '+33123456789',
      password:
        '$2a$10$XZ6FQellqQWydUCEcBhPjutqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJq', // password123 (sera mis √† jour par le script)
      roles: ['ADMIN'], // Chang√© de 'role' √† 'roles' (array)
      status: 'ACTIVE',
      emailVerified: true,
      isEmailVerified: true,
        createdAt: new Date(),
        updatedAt: new Date(),
      });
      print('‚úÖ Utilisateur admin cr√©√©');
    } else {
      print('‚ÑπÔ∏è  Utilisateur admin existe d√©j√†');
    }

    // Sp√©cialit√©s par d√©faut (seulement si la collection est vide)
    const specialitiesCount = db.specialities.countDocuments();
    if (specialitiesCount === 0) {
      const specialities = [
      { name: 'M√©decine g√©n√©rale', category: 'HEALTH' },
      { name: 'Cardiologie', category: 'HEALTH' },
      { name: 'Dermatologie', category: 'HEALTH' },
      { name: 'Gyn√©cologie', category: 'HEALTH' },
      { name: 'P√©diatrie', category: 'HEALTH' },
      { name: 'Psychiatrie', category: 'HEALTH' },
      { name: 'Radiologie', category: 'HEALTH' },
      { name: 'Chirurgie', category: 'HEALTH' },
      { name: 'Ophtalmologie', category: 'HEALTH' },
      { name: 'ORL', category: 'HEALTH' },
      { name: 'Neurologie', category: 'HEALTH' },
      { name: 'Urologie', category: 'HEALTH' },
      { name: 'Orthop√©die', category: 'HEALTH' },
      { name: 'Anesth√©sie', category: 'HEALTH' },
      { name: 'M√©decine du travail', category: 'HEALTH' },
      { name: 'M√©decine du sport', category: 'HEALTH' },
      { name: "M√©decine d'urgence", category: 'HEALTH' },
      { name: 'M√©decine interne', category: 'HEALTH' },
      { name: 'Endocrinologie', category: 'HEALTH' },
      { name: 'Gastro-ent√©rologie', category: 'HEALTH' },
      { name: 'H√©matologie', category: 'HEALTH' },
      { name: 'Infectiologie', category: 'HEALTH' },
      { name: 'N√©phrologie', category: 'HEALTH' },
      { name: 'Oncologie', category: 'HEALTH' },
      { name: 'Pneumologie', category: 'HEALTH' },
      { name: 'Rhumatologie', category: 'HEALTH' },
      { name: 'M√©decine l√©gale', category: 'HEALTH' },
      { name: 'M√©decine pr√©ventive', category: 'HEALTH' },
        { name: 'M√©decine de famille', category: 'HEALTH' },
      ];

      db.specialities.insertMany(specialities);
      print('‚úÖ Sp√©cialit√©s m√©dicales ins√©r√©es');
    } else {
      print('‚ÑπÔ∏è  Sp√©cialit√©s existent d√©j√† (' + specialitiesCount + ' sp√©cialit√©s)');
    }

    print('‚úÖ Initialisation MongoDB termin√©e avec succ√®s!');
    print(
      'üìä Collections cr√©√©es: users, services, bookings, invoices, transactions, partners, specialities'
    );
    print('üë§ Utilisateur admin cr√©√©: admin@diaspomoney.fr / password123');
    print('üè• Sp√©cialit√©s m√©dicales ins√©r√©es');
    print(
      'üîó Connexion: mongodb://diaspomoney:password123@localhost:27017/diaspomoney'
    );

